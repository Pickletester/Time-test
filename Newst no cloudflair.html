<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Court 2 — TB1-SAFE (30s fade)</title>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    html, body {
      margin:0; padding:0; width:100vw; height:100vh;
      overflow:hidden; background:transparent;
      font-family: Arial, Helvetica, sans-serif;
    }

    .bar{
      position:fixed; left:0; right:0; bottom:0; height:72px;
      display:grid; grid-template-columns:1.2fr 2.2fr 1.1fr 2.1fr 1.2fr;
      gap:4px; padding:8px 12px; box-sizing:border-box;
      transition: background 400ms ease;
      background:linear-gradient(90deg,#14203a,#22335d 70%);
    }
    .bar.red{
      background:linear-gradient(90deg,#4a0000,#c02020 70%);
    }

    .sec{
      position:relative;
      display:flex; flex-direction:column;
      justify-content:center; align-items:center;
      overflow:hidden; border-radius:6px;
    }
    .sec:not(#cn)::before{
      content:""; position:absolute;
      left:3px; right:3px; top:3px; bottom:3px;
      background:#000; opacity:.78; border-radius:6px;
    }

    .label{
      font-weight:700; text-transform:uppercase;
      font-size:10px; letter-spacing:.08em;
      z-index:1; margin-bottom:1px; color:#d4e5fd;
    }
    #cur .label{ color:#6cff6c; }
    #nxt .label{ color:#ffe56b; }

    .val{
      font-weight:800; z-index:1;
      text-align:center; line-height:1.08;
      color:#fff; padding:0 6px;
    }
    #cur .val, #nxt .val{
      font-size:14px;
      white-space:normal; overflow-wrap:anywhere; word-break:break-word;
    }
    #cd .val{ font-size:20px; }
    #now .val{ font-size:16px; }

    #cn{ transition: background 400ms ease; }
    #cn.alert::before{
      content:""; position:absolute;
      left:3px; right:3px; top:3px; bottom:3px;
      background:linear-gradient(180deg,#4a0000,#a80000);
      opacity:.65; border-radius:10px;
    }
    #cn .val{
      position:relative;
      font-size:58px; font-weight:900;
      padding:2px 12px; letter-spacing:.02em;
      border:3px solid #fff; border-radius:10px;
      text-shadow:0 1px 2px rgba(0,0,0,.4);
      transition: border-color 300ms ease;
    }

    .pulse-blue { animation: pulseBlue 2.8s ease-in-out infinite; }
    .pulse-blue::after{
      content:""; position:absolute;
      left:-5px; right:-5px; top:-5px; bottom:-5px;
      border-radius:14px;
      animation: glowBlue 2.8s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes pulseBlue {
      0%,100%{ border-color:#ffffff; }
      50%{ border-color:#7fbfff; }
    }
    @keyframes glowBlue {
      0%,100%{ box-shadow:0 0 6px rgba(0,128,255,0.25); }
      50%{ box-shadow:0 0 14px rgba(0,128,255,0.45); }
    }

    .pulse-red { animation: pulseRed 2.2s ease-in-out infinite; }
    .pulse-red::after{
      content:""; position:absolute;
      left:-6px; right:-6px; top:-6px; bottom:-6px;
      border-radius:14px;
      animation: glowRed 2.2s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes pulseRed {
      0%,100%{ border-color:#ffffff; }
      50%{ border-color:#ff5a5a; }
    }
    @keyframes glowRed {
      0%,100%{ box-shadow:0 0 8px rgba(255,0,0,0.25); }
      50%{ box-shadow:0 0 22px rgba(255,0,0,0.7); }
    }
    .nopulse { animation:none; }
    .nopulse::after{ content:none; }

    .expired-msg { font-size:28px; color:#ff4444; font-weight:900; }
    .meta{ font-size:12px; color:#d8d8d8; }

    /* ===== POPUP OVERLAY WITH GLOW (ON-THE-MINUTE) ===== */
    #infoOverlay{
      position:fixed;
      top:0; left:0; right:0; bottom:0;
      z-index:9999;
      background:rgba(0,0,0,.82);
      display:flex;
      align-items:center;
      justify-content:center;
      opacity:0;
      pointer-events:none;
      transition:opacity 800ms ease;
    }
    #infoOverlay.active{
      opacity:1;
      pointer-events:auto;
    }
    .overlayBox{
      background-color:#0c0c0c;
      border-radius:30px;
      padding:45px 80px 55px 80px;
      max-width:80%;
      text-align:center;
      color:#fff;
      transform:scale(.82);
      box-shadow:
        0 0 15px rgba(0,140,255,.55),
        0 0 30px rgba(0,90,255,.45),
        0 0 60px rgba(60,120,255,.35);
    }
    #infoOverlay.active .overlayBox{
      animation: popIn .9s cubic-bezier(.18,.89,.32,1) forwards,
                 glowPulse 2.8s ease-in-out infinite;
    }

    .overlayLogo{
      display:block;
      margin:0 auto 12px auto;
      max-width:420px;
      max-height:120px;
      filter: drop-shadow(0 6px 8px rgba(0,0,0,0.65))
              drop-shadow(0 0 10px rgba(0,0,0,0.45));
    }
    .overlayLevel{
      font-size:56px;
      font-weight:900;
      margin:16px 0 16px 0;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:#000000;
    }
    .overlayBody{
      font-size:30px;
      line-height:1.25;
      font-weight:700;
      margin-top:10px;
    }

    @keyframes popIn{
      0%{ transform:scale(.7); opacity:0; }
      80%{ transform:scale(1.05); }
      100%{ transform:scale(1); opacity:1; }
    }
    @keyframes glowPulse{
      0%,100%{
        box-shadow:
          0 0 15px rgba(0,140,255,.55),
          0 0 30px rgba(0,90,255,.45),
          0 0 60px rgba(60,120,255,.35);
      }
      50%{
        box-shadow:
          0 0 30px rgba(0,180,255,.9),
          0 0 60px rgba(0,120,255,.7),
          0 0 90px rgba(80,180,255,.6);
      }
    }
  </style>
</head>
<body>
  <!-- COURT BAR -->
  <div class="bar" id="bar">
    <div id="cn" class="sec"><div class="val pulse-blue" id="cno">1</div></div>
    <div id="cur" class="sec"><div class="label">In Progress</div><div class="val" id="curv">Loading...</div></div>
    <div id="cd" class="sec"><div class="label" id="cdlbl">Time Left</div><div class="val" id="cdv">--</div></div>
    <div id="nxt" class="sec"><div class="label">Upcoming</div><div class="val" id="nxtv">Loading next...</div></div>
    <div id="now" class="sec"><div class="label">Current Time</div><div class="val" id="clock">--:--</div></div>
  </div>

  <!-- FULL-SCREEN POPUP OVERLAY -->
  <div id="infoOverlay">
    <div class="overlayBox" id="overlayBox">
      <img src="levelup-logo.png" alt="LevelUp Pickleball" class="overlayLogo">
      <div class="overlayLevel" id="overlayLevel" style="display:none;"></div>
      <div class="overlayBody" id="overlayBody">Loading...</div>
    </div>
  </div>

<script>
(function(){
  // ======= CONFIG =======
  var COURT_NO      = 2;   // <<< CHANGE PER COURT
  var ORG_MEMBER_ID = "12674";
  var AUTH_B64      = "Basic T3JnXzEyNjc0OjEyNjc0XzE4NWFmZGE3LTdiNGYtNGIwYS04YmEwLWE3OWVhYzc4ODExZA==";
  var TZ            = "America/New_York";

  var currentLevelLabel = "";
  var currentLevelBg    = "#0c0c0c";

  // ======= UTIL =======
  function pad2(n){ return (n<10?"0":"")+n; }

  function toLocalNY(d){
    try{
      return d.toLocaleTimeString('en-US', {
        hour:'numeric', minute:'2-digit', hour12:true, timeZone: TZ
      });
    } catch(e){
      return d.getHours()+":"+pad2(d.getMinutes());
    }
  }

  function todayStrNY(){
    try{
      return new Intl.DateTimeFormat('en-CA',{
        timeZone:TZ,year:'numeric',month:'2-digit',day:'2-digit'
      }).format(new Date());
    } catch(e){
      var n=new Date();
      return n.getFullYear()+"-"+pad2(n.getMonth()+1)+"-"+pad2(n.getDate());
    }
  }

  function parseTimeAny(t){
    if(!t){return null;}
    if(Object.prototype.toString.call(t)==='[object Date]'){
      return isNaN(t.getTime())?null:t;
    }
    if(typeof t==='number'){ return new Date(t>1e12?t:t*1000); }
    if(typeof t==='string'){
      var s=t.trim();
      var m=s.match(/^\/Date\((\d+)\)\/$/i);
      if(m){ return new Date(parseInt(m[1],10)); }
      var d=new Date(s);
      if(!isNaN(d.getTime())) return d;
    }
    return null;
  }

  function pickArray(c){
    if(!c){return [];}
    if(c instanceof Array){return c;}
    if(typeof c==='object'){
      if(c.Data && c.Data instanceof Array) return c.Data;
      if(c.data && c.data instanceof Array) return c.data;
      if(c.Items && c.Items instanceof Array) return c.Items;
      if(c.Results && c.Results instanceof Array) return c.Results;
    }
    return [];
  }

  // ======= SMART COURT FILTER (no Title dependency) =======
  function containsCourtN(rec, n){
    n = Number(n) || 1;
    if(!rec) return false;
    var visited = (typeof WeakSet !== "undefined") ? new WeakSet() : null;

    function stringHasCourtN(str, n){
      if(!str) return false;
      var s = String(str).toLowerCase();
      if(s.indexOf("court") === -1) return false;

      if(s.indexOf("court #"+n) >= 0) return true;
      if(s.indexOf("court "+n)  >= 0) return true;
      if(s.indexOf("courts "+n) >= 0) return true;

      var rg = /courts?\s*#?\s*(\d+)\s*[-–]\s*#?\s*(\d+)/g;
      var m;
      while((m = rg.exec(s)) !== null){
        var a = +m[1], b = +m[2];
        if(n >= Math.min(a,b) && n <= Math.max(a,b)) return true;
      }

      if(s.indexOf(",") >= 0 || s.indexOf("&") >= 0 || s.indexOf("/") >= 0){
        var listRg = /court(?:s)?[^0-9]*((\d+)(?:\s*[,/&]\s*\d+)*)/gi;
        var lm;
        while((lm = listRg.exec(s)) !== null){
          var nums = lm[1].split(/[,/&]/);
          for(var i=0;i<nums.length;i++){
            var num = parseInt(nums[i],10);
            if(num === n) return true;
          }
        }
      }
      return false;
    }

    function scan(value, keyHint){
      if(value == null) return false;
      var t = typeof value;

      if(t === "number"){
        return value === n;
      }
      if(t === "string"){
        return stringHasCourtN(value, n);
      }
      if(Array.isArray(value)){
        for(var i=0;i<value.length;i++){
          if(scan(value[i], keyHint)) return true;
        }
        return false;
      }
      if(t === "object"){
        if(visited && visited.has(value)) return false;
        if(visited) visited.add(value);
        for(var k in value){
          if(!Object.prototype.hasOwnProperty.call(value,k)) continue;
          var lowK = k.toLowerCase();
          // skip name/title fields so we don't match "(Courts 1-3)" text
          if(lowK === "title" || lowK === "eventname" || lowK === "name") continue;
          if(scan(value[k], k)) return true;
        }
      }
      return false;
    }

    return scan(rec, "");
  }

  // ======= CLOCK =======
  function tickClock(){
    var el = document.getElementById('clock');
    el.textContent = toLocalNY(new Date());
    var now = new Date();
    var delay = 1000 - (now.getMilliseconds());
    if(delay < 250) delay = 250;
    setTimeout(tickClock, delay);
  }

  // ======= XHR =======
  function xhrJSON(url, headers, timeoutMs, cb){
    try{
      var x = new XMLHttpRequest();
      x.open("GET", url, true);
      x.timeout = timeoutMs||8000;
      if(headers){
        for(var k in headers){
          if(headers.hasOwnProperty(k)){
            x.setRequestHeader(k, headers[k]);
          }
        }
      }
      x.onreadystatechange = function(){
        if(x.readyState === 4){
          if(x.status >= 200 && x.status < 300){
            var data=null;
            try{ data=JSON.parse(x.responseText); }catch(e){ data=null; }
            cb(null, data);
          } else { cb(new Error("HTTP "+x.status)); }
        }
      };
      x.ontimeout = function(){ cb(new Error("timeout")); };
      x.onerror   = function(){ cb(new Error("network")); };
      x.send();
    }catch(e){ cb(e); }
  }

  // ======= RENDER / STATE =======
  var cdTimer = null, cdMode = "none", cdTarget = null;
  var nxtStart = null;
  var lastCurName = "";
  var lastGood = null;

  function setPulse(mode){
    var el = document.getElementById('cno');
    el.className = "val";
    if(mode === "blue"){ el.className += " pulse-blue"; }
    else if(mode === "red"){ el.className += " pulse-red"; }
    else { el.className += " nopulse"; }
  }

  function setBar(mode){
    var bar = document.getElementById('bar');
    var cn  = document.getElementById('cn');
    if(mode === "red"){
      bar.className = "bar red";
      cn.className  = "sec alert";
    } else {
      bar.className = "bar";
      cn.className  = "sec";
    }
  }

  function resetExpiredVisuals(){
    var outEl = document.getElementById("cdv");
    outEl.className = "val";
    var lblEl = document.getElementById("cdlbl");
    lblEl.className = "label";
    lblEl.textContent = (cdMode === "next") ? "Time Until" : "Time Left";
  }

  function startCountdown(targetMs, mode){
    cdTarget = targetMs; cdMode = mode||"none";
    if(cdTimer){ clearTimeout(cdTimer); cdTimer = null; }

    function tick(){
      var out = document.getElementById('cdv');
      var lbl = document.getElementById('cdlbl');

      if(!cdTarget){
        out.className = "val";
        out.textContent = "--";
        lbl.textContent = "Time Left";
        setPulse("blue");
        setBar("blue");
        cdTimer = setTimeout(tick, 1000);
        return;
      }

      var nowMs = (new Date()).getTime();
      var diff  = cdTarget - nowMs;

      if(diff > 0){
        if(cdMode === "cur" && diff <= 60000){
          setPulse("red"); setBar("red");
        } else {
          setPulse("blue"); setBar("blue");
        }

        if(out.className.indexOf("expired-msg") !== -1){
          out.className = "val";
        }

        var totalSec = Math.floor(diff/1000);
        var totalMin = Math.floor(diff/60000);
        if(diff <= 60000){
          out.textContent = (totalSec%60) + "s";
        } else if(totalMin >= 60){
          out.textContent = Math.floor(totalMin/60) + "h " + (totalMin%60) + "m";
        } else {
          out.textContent = totalMin + "m";
        }

        lbl.textContent = (cdMode === "cur") ? "Time Left" : "Time Until";
        cdTimer = setTimeout(tick, 1000);

      } else {
        // REACHED ZERO
        if (cdMode === "cur") {
          // show TIME EXPIRED for ~30 seconds
          setPulse("red"); setBar("red");
          lbl.textContent = "";
          out.className = "val expired-msg";
          out.textContent = "TIME EXPIRED";

          var curEl = document.getElementById('curv');
          if(lastCurName){ curEl.innerHTML = "Time expired — " + lastCurName; }
          else { curEl.innerHTML = "Time expired"; }

          setTimeout(function(){
            setPulse("blue"); setBar("blue");
            resetExpiredVisuals();
            if(nxtStart){
              // if there's a next event, go into next countdown
              cdMode   = "next";
              cdTarget = nxtStart;
              tick();
            } else {
              // no upcoming event: clear everything so it doesn't stick
              cdMode   = "none";
              cdTarget = null;
              lastGood = null;
              refresh(true); // force re-eval + render(null,null)
            }
          }, 30000);

        } else if (cdMode === "next") {
          // next just hit zero -> force fresh data so it flips to In Progress quickly
          cdTarget = null;
          cdMode   = "none";
          out.className = "val";
          out.textContent = "--";
          lbl.textContent = "Time Left";
          setPulse("blue"); setBar("blue");
          try{ refresh(true); }catch(e){}

        } else {
          setPulse("blue"); setBar("blue");
          lbl.textContent = "Time Until";
          out.className = "val";
          out.textContent = "--";
          cdTarget = null;
          cdTimer = setTimeout(tick, 2000);
        }
      }
    }
    tick();
  }

  function fmtTime(d){
    return "<div class='meta'>"+toLocalNY(d.start)+" - "+toLocalNY(d.end)+"</div>";
  }

  // ===== LEVEL COLOR / LABEL FROM TITLE (UPDATED RANGES) =====
  function getLevelInfoFromTitle(title){
    var t = (title || "");
    var tLow  = t.toLowerCase();
    var tNorm = tLow.replace(/\s+/g,"").replace(/–/g,"-").replace(/—/g,"-");

    var info = {
      bubbleColor: null,
      label: "",
      overlayBg: "#0c0c0c"
    };

    // 4.5+
    if (
      tNorm.indexOf("4.5+") >= 0 ||
      tNorm.indexOf("4.5-") >= 0 ||
      tNorm.indexOf("5.0") >= 0
    ){
      info.bubbleColor = "#dc2626"; // RED
      info.label       = "4.5+";
      info.overlayBg   = "#b91c1c";

    // 4.0–4.49
    } else if (
      tNorm.indexOf("4.0-4.4")  >= 0 ||
      tNorm.indexOf("4.0-4.49") >= 0 ||
      tNorm.indexOf("4.0-4.5")  >= 0 ||
      tNorm.indexOf("4.0-4")    >= 0
    ){
      info.bubbleColor = "#f97316"; // ORANGE
      info.label       = "4.0–4.49";
      info.overlayBg   = "#ea580c";

    // 3.5–3.99
    } else if (
      tNorm.indexOf("3.5-3.9")  >= 0 ||
      tNorm.indexOf("3.5-3.99") >= 0 ||
      tNorm.indexOf("3.5+")     >= 0
    ){
      info.bubbleColor = "#8b5cf6"; // PURPLE
      info.label       = "3.5–3.99";
      info.overlayBg   = "#6d28d9";

    // 3.0–3.49
    } else if (
      tNorm.indexOf("3.0-3.4")  >= 0 ||
      tNorm.indexOf("3.0-3.49") >= 0
    ){
      info.bubbleColor = "#22c55e"; // GREEN
      info.label       = "3.0–3.49";
      info.overlayBg   = "#15803d";

    // 2.0–2.99
    } else if (
      tNorm.indexOf("2.0-2.9")  >= 0 ||
      tNorm.indexOf("2.0-2.99") >= 0
    ){
      info.bubbleColor = "#38bdf8"; // LIGHT BLUE
      info.label       = "2.0–2.99";
      info.overlayBg   = "#0ea5e9";

    // TEXT FALLBACKS
    } else {

      if(tLow.indexOf("advanced") >= 0){
        info.bubbleColor = "#dc2626";
        info.label       = "4.5+";
        info.overlayBg   = "#b91c1c";

      } else if(tLow.indexOf("intermediate+") >= 0){
        info.bubbleColor = "#8b5cf6";
        info.label       = "3.5–3.99";
        info.overlayBg   = "#6d28d9";

      } else if(tLow.indexOf("intermediate") >= 0){
        info.bubbleColor = "#22c55e";
        info.label       = "3.0–3.49";
        info.overlayBg   = "#15803d";

      } else if(tLow.indexOf("beginner") >= 0){
        info.bubbleColor = "#38bdf8";
        info.label       = "2.0–2.99";
        info.overlayBg   = "#0ea5e9";
      }
    }
    return info;
  }

  // ===== CANCELLED EVENT FILTER =====
  function isCancelledEvent(x){
    if(!x || typeof x !== "object") return false;

    if(x.IsCanceled === true || x.IsCancelled === true || x.Cancelled === true) return true;
    if(x.IsActive === false || x.Active === false) return true;

    var statusStr = "";
    if(typeof x.Status === "string")              statusStr += " " + x.Status;
    if(typeof x.EventStatus === "string")         statusStr += " " + x.EventStatus;
    if(typeof x.RegistrationStatus === "string")  statusStr += " " + x.RegistrationStatus;

    statusStr = statusStr.toLowerCase();
    if(statusStr.indexOf("cancel") >= 0) return true;

    return false;
  }

  function render(cur, nxt){
    var curEl = document.getElementById('curv');
    var nxtEl = document.getElementById('nxtv');

    if(cur){
      lastCurName = cur.name + fmtTime(cur);

      curEl.className = "val";
      curEl.style.backgroundColor = "";
      curEl.style.borderRadius = "";
      curEl.style.padding = "";
      curEl.style.color = "";

      var levelInfo = getLevelInfoFromTitle(cur.name || "");
      currentLevelLabel = levelInfo.label;
      currentLevelBg    = levelInfo.overlayBg;

      if(levelInfo.bubbleColor){
        curEl.style.backgroundColor = levelInfo.bubbleColor;
        curEl.style.borderRadius    = "999px";
        curEl.style.padding         = "3px 10px";
        curEl.style.color           = "#ffffff";
      }

      curEl.innerHTML = cur.name + fmtTime(cur);
      startCountdown(cur.end.getTime(), "cur");
    } else {
      currentLevelLabel = "";
      currentLevelBg    = "#0c0c0c";

      curEl.className = "val";
      curEl.style.backgroundColor = "";
      curEl.style.borderRadius = "";
      curEl.style.padding = "";
      curEl.textContent = "No current event";

      if(nxt){ startCountdown(nxt.start.getTime(), "next"); }
      else    { startCountdown(null, "none"); }
    }

    if(nxt){ nxtEl.innerHTML = nxt.name + fmtTime(nxt); }
    else   { nxtEl.textContent = "No upcoming event"; }
  }

  // ======= DATA =======
  function buildDayUrls(){
    var d   = todayStrNY();
    var rnd = new Date().getTime();
    var ev  = "https://api.courtreserve.com/api/v1/eventcalendar/eventlist"
            + "?orgMemberId="+encodeURIComponent(ORG_MEMBER_ID)
            + "&startDate="+d+"T00:00:00&endDate="+d+"T23:59:59"
            + "&r="+rnd;
    var res = "https://api.courtreserve.com/api/v1/reservationreport/listactive"
            + "?orgMemberId="+encodeURIComponent(ORG_MEMBER_ID)
            + "&reservationsFromDate="+d+"T00:00:00"
            + "&reservationsToDate="+d+"T23:59:59"
            + "&includePlayers=true"
            + "&r="+rnd;
    return {ev:ev, res:res};
  }

  function normalizeEvent(x){
    if(isCancelledEvent(x)) return null;
    var nm = (x.EventName || x.Name || x.Title || "Event");
    var s  = parseTimeAny(x.StartDateTime||x.StartTime||x.Start);
    var e  = parseTimeAny(x.EndDateTime  ||x.EndTime  ||x.End);
    return (s && e) ? {kind:"event", name:nm, start:s, end:e, raw:x} : null;
  }

  function shortName(p){
    var fn = (p.FirstName||"").trim();
    var ln = (p.LastName||"").trim();
    var init = fn ? (fn.charAt(0).toUpperCase()+".") : "";
    return (init && ln) ? (init+" "+ln) : (init || ln || "");
  }

  function normalizeResv(x){
    var s = parseTimeAny(x.StartTime||x.StartDateTime||x.Start);
    var e = parseTimeAny(x.EndTime||x.EndDateTime||x.End);
    if(!s || !e) return null;
    var name = "";
    if(x.Players && x.Players instanceof Array && x.Players.length){
      var arr = [];
      for(var i=0;i<x.Players.length;i++){
        arr.push(shortName(x.Players[i]||{}));
      }
      name = arr.join(", ");
    }
    if(!name && x.ReservationTypeName) name = x.ReservationTypeName;
    if(!name) name = "Reserved";
    return {kind:"res", name:name, start:s, end:e, raw:x};
  }

  var toggle = 0, cacheEv = [], cacheRes = [], cacheDate = "";

  function refresh(forceNoToggle){
    var dstr = todayStrNY();
    if(cacheDate !== dstr){
      cacheEv=[]; cacheRes=[]; cacheDate=dstr; toggle=0;
    }

    var urls = buildDayUrls();

    if(forceNoToggle){
      xhrJSON(urls.ev,  {"Authorization":AUTH_B64}, 8000, function(errE, dataE){
        if(!errE){ cacheEv = pickArray(dataE); }
        xhrJSON(urls.res, {"Authorization":AUTH_B64}, 8000, function(errR, dataR){
          if(!errR){ cacheRes = pickArray(dataR); }
          computeAndRender();
        });
      });
      return;
    }

    if(toggle === 0){
      xhrJSON(urls.ev, {"Authorization":AUTH_B64}, 8000, function(errE, dataE){
        if(!errE){ cacheEv = pickArray(dataE); }
        xhrJSON(urls.res, {"Authorization":AUTH_B64}, 8000, function(errR, dataR){
          if(!errR){ cacheRes = pickArray(dataR); }
          toggle = 1;
          computeAndRender();
        });
      });
    } else if((toggle % 2) === 1){
      xhrJSON(urls.ev, {"Authorization":AUTH_B64}, 8000, function(errE, dataE){
        if(!errE){ cacheEv = pickArray(dataE); }
        toggle++;
        computeAndRender();
      });
    } else {
      xhrJSON(urls.res, {"Authorization":AUTH_B64}, 8000, function(errR, dataR){
        if(!errR){ cacheRes = pickArray(dataR); }
        toggle++;
        computeAndRender();
      });
    }
  }

  function computeAndRender(){
    var ev = [], rs = [], i;

    for(i=0;i<cacheEv.length;i++){
      var a = normalizeEvent(cacheEv[i]);
      if(a){ ev.push(a); }
    }
    for(i=0;i<cacheRes.length;i++){
      var b = normalizeResv(cacheRes[i]);
      if(b){ rs.push(b); }
    }

    var evC = [], rsC = [];
    for(i=0;i<ev.length;i++){
      if(containsCourtN(ev[i].raw, COURT_NO)) evC.push(ev[i]);
    }
    for(i=0;i<rs.length;i++){
      if(containsCourtN(rs[i].raw, COURT_NO)) rsC.push(rs[i]);
    }

    var all = rsC.concat(evC);
    all.sort(function(a,b){ return a.start - b.start; });

    var now = new Date();
    var cur = null, nxt = null;

    for(i=0;i<all.length;i++){
      var it = all[i];

      if(now >= it.start && now <= it.end){
        if(!cur){
          cur = it;
        } else {
          if(cur.kind === "event" && it.kind === "res"){
            cur = it;
          }
        }
      }

      if(!nxt && now < it.start){
        nxt = it;
      }
    }

    nxtStart = nxt ? nxt.start.getTime() : null;

    if(cur || nxt){ lastGood = {cur:cur, nxt:nxt}; }
    if(cur || nxt){ render(cur, nxt); }
    else if(lastGood){ render(lastGood.cur, lastGood.nxt); }
    else { render(null, null); }
  }

  // ===== POPUP OVERLAY LOOP =====
  var infoOverlay   = document.getElementById("infoOverlay");
  var overlayBodyEl = document.getElementById("overlayBody");
  var overlayBoxEl  = document.getElementById("overlayBox");
  var overlayLevelEl= document.getElementById("overlayLevel");

  function applyOverlayLevelStyles(){
    if(!overlayBoxEl || !overlayLevelEl) return;

    if(currentLevelLabel){
      overlayLevelEl.style.display = "block";
      overlayLevelEl.textContent  = currentLevelLabel;
      overlayBoxEl.style.backgroundColor = currentLevelBg || "#0c0c0c";
    } else {
      overlayLevelEl.style.display = "none";
      overlayLevelEl.textContent  = "";
      overlayBoxEl.style.backgroundColor = "#0c0c0c";
    }
  }

  function showInfoOverlay(){
    if(!infoOverlay) return;
    var curEl = document.getElementById("curv");
    if(curEl && overlayBodyEl){
      overlayBodyEl.innerHTML = curEl.innerHTML || curEl.textContent || "";
    }
    applyOverlayLevelStyles();
    infoOverlay.classList.add("active");
    setTimeout(function(){
      infoOverlay.classList.remove("active");
    }, 10000);
  }

  function startOverlayMinuteLoop(){
    if(!infoOverlay) return;
    var now = new Date();
    var msUntilNextMinute = (60 - now.getSeconds()) * 1000 - now.getMilliseconds();
    if(msUntilNextMinute < 100){ msUntilNextMinute = 100; }

    setTimeout(function(){
      showInfoOverlay();
      setInterval(showInfoOverlay, 60000);
    }, msUntilNextMinute);
  }

  // ===== INIT =====
  document.getElementById('cno').textContent = String(COURT_NO);
  tickClock();
  refresh(false);
  setInterval(refresh, 30000);
  startOverlayMinuteLoop();
})();
</script>
</body>
</html>
